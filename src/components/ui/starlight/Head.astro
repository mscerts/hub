---
import type { Props } from "@astrojs/starlight/props";
import StarlightHead from "@astrojs/starlight/components/Head.astro";
import VtbotStarlight from "astro-vtbot/components/starlight/Base.astro";
import CookieConsentBanner from "@components/ui/banners/CookieConsentBanner.astro";
import CookieConsentModal from "@components/ui/modals/CookieConsentModal.astro";
import AnnouncementBanner from "@components/ui/banners/AnnouncementBanner.astro";
---

<VtbotStarlight {...Astro.props} viewTransitionsFallback="animate">
  <StarlightHead {...Astro.props}>
    <slot />
  </StarlightHead>
</VtbotStarlight>

<!-- Cookie Consent Components -->
<CookieConsentBanner />
<CookieConsentModal />
  <AnnouncementBanner
    btnId="dismiss-button"
    btnTitle="New GitHub Certifications on the Hub"
    btnTitleMobile="New GitHub Certs"
    url="/blog/githubexamsandignite/"
  />
<style is:global>
  /* Slow down Chrome's default animation */
  ::view-transition-group(root) {
    animation-duration: 250ms;
  }

  /* Do not slide over the sidebars */
  ::view-transition-group(*) {
    overflow: hidden;
  }
</style>

<script is:inline>
  // Force reload all stylesheets on navigation to fix CSS loading issues
  document.addEventListener("astro:before-swap", (ev) => {
    // Get all link elements with stylesheets
    const oldStyles = [...document.querySelectorAll('link[rel="stylesheet"]')];
    const newDoc = ev.newDocument;
    const newStyles = [...newDoc.querySelectorAll('link[rel="stylesheet"]')];
    
    // Ensure new styles are loaded
    newStyles.forEach((newStyle) => {
      const href = newStyle.getAttribute('href');
      const existing = oldStyles.find(s => s.getAttribute('href') === href);
      if (!existing) {
        // Add new stylesheet to current document before swap
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        document.head.appendChild(link);
      }
    });
  });

  document.addEventListener("astro:after-swap", () => {
    // Force repaint to ensure styles are applied
    document.documentElement.style.display = 'none';
    document.documentElement.offsetHeight; // trigger reflow
    document.documentElement.style.display = '';
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const siteSearch = document.querySelector(
      "site-search"
    ) as HTMLElement | null;
    if (siteSearch) {
      siteSearch.setAttribute("data-lenis-prevent", "");
    }
    
    // Prevent Lenis from interfering with sidebar scrolling
    const sidebar = document.querySelector("#starlight__sidebar") as HTMLElement | null;
    if (sidebar) {
      sidebar.setAttribute("data-lenis-prevent", "");
    }
    
    // Also prevent Lenis interference with right sidebar
    const rightSidebar = document.querySelector(".right-sidebar") as HTMLElement | null;
    if (rightSidebar) {
      rightSidebar.setAttribute("data-lenis-prevent", "");
    }

    // Force full page reload for blog links
    document.querySelectorAll('a[href*="/blog/"]').forEach((link) => {
      link.setAttribute('data-astro-reload', '');
    });
  });

  // Also handle dynamically added links
  document.addEventListener("astro:page-load", () => {
    document.querySelectorAll('a[href*="/blog/"]').forEach((link) => {
      link.setAttribute('data-astro-reload', '');
    });
  });
</script>
